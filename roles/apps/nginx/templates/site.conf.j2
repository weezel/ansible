server {
	listen	80;
	server_name {{site_name}} www.{{site_name}};

{% if ansible_system == "Linux" %}
	access_log /var/log/nginx/{{site_name}}_access.log;
	error_log  /var/log/nginx/{{site_name}}_error.log;
{% elif ansible_system == "OpenBSD" %}
	access_log /var/www/logs/{{site_name}}_access.log;
	error_log  /var/www/logs/{{site_name}}_error.log;
{% endif %}

	return 301 https://www.{{site_name}}$request_uri;
}

server {
	listen	443 default_server ssl;
	server_name {{site_name}} www.{{site_name}};

{% if ansible_system == "Linux" %}
	access_log /var/log/nginx/{{site_name}}-ssl_access.log;
	error_log  /var/log/nginx/{{site_name}}-ssl_error.log;
{% elif ansible_system == "OpenBSD" %}
	access_log /var/www/logs/{{site_name}}-ssl_access.log;
	error_log  /var/www/logs/{{site_name}}-ssl_error.log;
{% endif %}

	ssl_certificate     /etc/nginx/certs/{{site_name}}/fullchain.pem;
	ssl_certificate_key /etc/nginx/certs/{{site_name}}/privkey.pem;

	ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
	ssl_prefer_server_ciphers on;
	ssl_dhparam /etc/ssl/dhparam.pem;
	ssl_ciphers 'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:CAMELLIA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA';
	ssl_session_timeout 1d;
	ssl_session_cache shared:SSL:50m;
	ssl_stapling on;
	ssl_stapling_verify on;
	add_header Strict-Transport-Security max-age=15768000;

	root /var/www/htdocs/{{site_name}};
	index index.php index.html index.htm;

	# Make site accessible from http://localhost/
	rewrite /wp-admin$ $scheme://$host$uri/ permanent;

	# Directives to send expires headers and turn off 404 error logging.
	location ~* ^.+\.(ogg|ogv|svg|svgz|eot|otf|woff|mp4|ttf|rss|atom|jpg|jpeg|gif|png|ico|zip|tgz|gz|rar|bz2|doc|xls|exe|ppt|tar|mid|midi|wav|bmp|rtf)$ {
		access_log off; log_not_found off; expires max;
	}

	location / {
		# First attempt to serve request as file, then
		# as directory, then fall back to displaying a 404.
		#try_files $uri $uri/ /index.html;
		try_files $uri $uri/ /index.php?args;
		# Uncomment to enable naxsi on this location
		# include /etc/nginx/naxsi.rules
	}

	location = /robots.txt {
		allow all;
		log_not_found off;
		access_log off;
	}

	location ~* \.(js|css|png|jpg|jpeg|gif|ico)$ {
		expires max;
		log_not_found off;
	}

	location ~* /(?:uploads|files)/.*\.php$ {
		deny all;
	}

	# Needed by Certbot (Letsencrypt)
	location ~ /.well-known {
		allow all;
	}

	#error_page 404 /404.html;

	# redirect server error pages to the static page /50x.html
	#
	#error_page 500 502 503 504 /50x.html;
	#location = /50x.html {
	#	root /usr/share/nginx/www;
	#}

	location ~ \.php$ {
		#include fastcgi.conf;
		fastcgi_intercept_errors on;
		fastcgi_split_path_info ^(.+\.php)(/.+)$;
		# NOTE: You should have "cgi.fix_pathinfo = 0;" in php.ini
		fastcgi_split_path_info ^(.+?\.php)(/.*)$;
		if (!-f $document_root$fastcgi_script_name) {
			return 404;
		}

{% if ansible_system == "Linux" %}
		fastcgi_pass unix:/var/run/php-fpm/php-fpm.sock;
{% elif ansible_system == "OpenBSD" %}
		fastcgi_pass unix:/var/www/run/php-fpm.sock;
{% endif %}
		fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
		fastcgi_param HTTP_PROXY "";
		fastcgi_index index.php;
		include fastcgi_params;
	}

	# deny access to .htaccess files
	location ~ /\.ht {
		deny all;
	}
}

